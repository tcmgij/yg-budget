<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Y&amp;G Budget</title>

  <!-- PWA / iPhone home screen -->
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Y&amp;G Budget"/>
  <meta name="theme-color" content="#0D0C0A"/>
  <meta name="mobile-web-app-capable" content="yes"/>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Lato:wght@300;400;700&display=swap"/>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: #0D0C0A; }
    body { font-family: 'Lato', sans-serif; font-weight: 300; color: #EDE0CC; -webkit-font-smoothing: antialiased; }
    input, select, button, textarea { font-family: inherit; }
    /* iOS safe-area support */
    #root { padding-bottom: env(safe-area-inset-bottom); }
    /* Hide scrollbar on webkit */
    ::-webkit-scrollbar { width: 0; background: transparent; }
    /* Remove iOS input zoom */
    input, select { font-size: 16px !important; }
    @media (min-width: 430px) { input, select { font-size: 14px !important; } }
  </style>

  <!-- React + Babel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>

  <!-- Recharts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.8.0/Recharts.min.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;
const { PieChart, Pie, Cell, LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } = Recharts;

// ── Storage: localStorage ─────────────────────────────────────────────────────
function lsLoad(key) {
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : null; } catch { return null; }
}
function lsSave(key, val) {
  try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
}

// ── Constants ─────────────────────────────────────────────────────────────────
const CAT_COLORS = ["#C9A84C","#E8C97A","#A07830","#D4B896","#8B7355","#F0DDB0","#6B5B3E","#EDD898","#B8975A","#785A2A"];
const DEFAULT_CATEGORIES = ["Housing","Groceries","Dining Out","Transport","Entertainment","Health","Subscriptions","Shopping","Travel","Other"];
const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const today = new Date();
const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}`;

function genId() { return Math.random().toString(36).slice(2,10)+Date.now().toString(36); }
function eur(n) { return `€${Number(n).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}`; }
function monthLabel(k) { if (!k) return ""; const [y,m]=k.split("-"); return `${MONTHS[parseInt(m,10)-1]} ${y}`; }

// ── Design tokens ─────────────────────────────────────────────────────────────
const C = {
  bg:"#0D0C0A", card:"#141210", border:"#252219",
  gold:"#C9A84C", goldDim:"#8A6E2E", text:"#EDE0CC",
  muted:"#7A6E5E", faint:"#3A342A", red:"#D46060", green:"#6AB07A",
};
const TT = {
  display: { fontFamily:"'Playfair Display',serif", fontWeight:500 },
};

const inputStyle = {
  width:"100%", background:"#1A1713", border:`1px solid ${C.border}`,
  borderRadius:10, color:C.text, padding:"11px 14px",
  fontFamily:"'Lato',sans-serif", outline:"none", boxSizing:"border-box",
  WebkitAppearance:"none", appearance:"none",
};
const labelStyle = {
  fontSize:10, color:C.muted, textTransform:"uppercase",
  letterSpacing:"0.1em", marginBottom:5, display:"block", fontFamily:"'Lato',sans-serif",
};

function Btn({ children, onClick, variant="primary", style={}, disabled=false }) {
  const variants = {
    primary: { background:C.gold, color:"#0D0C0A", border:"none" },
    ghost:   { background:"transparent", color:C.muted, border:`1px solid ${C.border}` },
    danger:  { background:"transparent", color:C.red, border:`1px solid ${C.red}33` },
    success: { background:"transparent", color:C.green, border:`1px solid ${C.green}44` },
  };
  return (
    <button onClick={disabled?undefined:onClick}
      style={{ padding:"11px 18px", borderRadius:10, cursor:disabled?"default":"pointer",
        fontSize:14, fontFamily:"'Lato',sans-serif", fontWeight:700, letterSpacing:"0.02em",
        transition:"opacity .15s", opacity:disabled?0.4:1, ...variants[variant], ...style }}>
      {children}
    </button>
  );
}

function Card({ children, style={} }) {
  return <div style={{ background:C.card, border:`1px solid ${C.border}`, borderRadius:14, padding:"1.1rem", ...style }}>{children}</div>;
}

function Tag({ label, color }) {
  return <span style={{ display:"inline-block", padding:"2px 8px", borderRadius:20, fontSize:10,
    background:`${color}22`, color, border:`1px solid ${color}44`, fontFamily:"'Lato',sans-serif" }}>{label}</span>;
}

function ChartTip({ active, payload, label }) {
  if (!active||!payload?.length) return null;
  return (
    <div style={{ background:"#1A1713", border:`1px solid ${C.border}`, borderRadius:8, padding:"8px 12px" }}>
      {label && <div style={{ fontSize:10, color:C.muted, marginBottom:3 }}>{label}</div>}
      {payload.map((p,i)=>(
        <div key={i} style={{ fontSize:13, color:p.color||C.gold, fontFamily:"'Lato',sans-serif" }}>
          {p.name?`${p.name}: `:""}{eur(p.value)}
        </div>
      ))}
    </div>
  );
}

const TABS = [
  { id:"dashboard", icon:"◈", label:"Overview" },
  { id:"add",       icon:"＋", label:"Add" },
  { id:"expenses",  icon:"≡",  label:"Expenses" },
  { id:"recurring", icon:"↻",  label:"Recurring" },
  { id:"settings",  icon:"⚙",  label:"Settings" },
];

// ── Root App ──────────────────────────────────────────────────────────────────
function App() {
  const [tab, setTab] = useState("dashboard");
  const [expenses, setExpenses] = useState([]);
  const [recurring, setRecurring] = useState([]);
  const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
  const [toast, setToast] = useState(null);

  // Load on mount
  useEffect(() => {
    const e = lsLoad("yg_expenses");
    const r = lsLoad("yg_recurring");
    const c = lsLoad("yg_categories");
    if (e) setExpenses(e);
    if (r) setRecurring(r);
    if (c) setCategories(c);
  }, []);

  // Persist on change
  useEffect(() => { lsSave("yg_expenses", expenses); }, [expenses]);
  useEffect(() => { lsSave("yg_recurring", recurring); }, [recurring]);
  useEffect(() => { lsSave("yg_categories", categories); }, [categories]);

  const showToast = (msg, type="ok") => {
    setToast({ msg, type });
    setTimeout(() => setToast(null), 2800);
  };

  return (
    <div style={{ minHeight:"100vh", background:C.bg, color:C.text,
      fontFamily:"'Lato',sans-serif", fontWeight:300, paddingBottom:88,
      maxWidth:430, margin:"0 auto", position:"relative" }}>

      {/* Header */}
      <div style={{ padding:"18px 18px 12px", borderBottom:`1px solid ${C.border}`,
        position:"sticky", top:0, background:C.bg, zIndex:50 }}>
        <div style={{ ...TT.display, fontSize:20, color:C.gold, letterSpacing:"0.03em" }}>Y&amp;G Budget</div>
        <div style={{ fontSize:10, color:C.muted, letterSpacing:"0.15em", textTransform:"uppercase", marginTop:1 }}>Household Tracker</div>
      </div>

      {/* Page content */}
      <div style={{ padding:"16px 16px 0" }}>
        {tab==="dashboard" && <Dashboard expenses={expenses} categories={categories}/>}
        {tab==="add"       && <AddExpense expenses={expenses} setExpenses={setExpenses} categories={categories} onDone={()=>{ showToast("Expense added ✓"); setTab("expenses"); }}/>}
        {tab==="expenses"  && <ExpenseList expenses={expenses} setExpenses={setExpenses} categories={categories}/>}
        {tab==="recurring" && <RecurringPage recurring={recurring} setRecurring={setRecurring} categories={categories} expenses={expenses} setExpenses={setExpenses} showToast={showToast}/>}
        {tab==="settings"  && <Settings expenses={expenses} recurring={recurring} categories={categories} setExpenses={setExpenses} setRecurring={setRecurring} setCategories={setCategories} showToast={showToast}/>}
      </div>

      {/* Toast */}
      {toast && (
        <div style={{ position:"fixed", bottom:100, left:"50%", transform:"translateX(-50%)",
          background:toast.type==="ok"?"#1E2A1E":"#2A1E1E",
          border:`1px solid ${toast.type==="ok"?C.green:C.red}55`,
          borderRadius:10, padding:"9px 18px", fontSize:13,
          color:toast.type==="ok"?C.green:C.red, zIndex:200,
          whiteSpace:"nowrap", fontFamily:"'Lato',sans-serif" }}>
          {toast.msg}
        </div>
      )}

      {/* Bottom Tab Bar */}
      <div style={{ position:"fixed", bottom:0, left:"50%", transform:"translateX(-50%)",
        width:"100%", maxWidth:430, background:C.card, borderTop:`1px solid ${C.border}`,
        display:"flex", zIndex:100, paddingBottom:"env(safe-area-inset-bottom)" }}>
        {TABS.map(t=>(
          <button key={t.id} onClick={()=>setTab(t.id)}
            style={{ flex:1, padding:"10px 0 13px", background:"none", border:"none",
              cursor:"pointer", display:"flex", flexDirection:"column", alignItems:"center", gap:3 }}>
            <span style={{ fontSize:t.id==="add"?22:16, color:tab===t.id?C.gold:C.faint, lineHeight:1 }}>{t.icon}</span>
            <span style={{ fontSize:9, color:tab===t.id?C.gold:C.muted,
              fontFamily:"'Lato',sans-serif", letterSpacing:"0.06em", textTransform:"uppercase" }}>{t.label}</span>
          </button>
        ))}
      </div>
    </div>
  );
}

// ── Dashboard ─────────────────────────────────────────────────────────────────
function Dashboard({ expenses, categories }) {
  const [viewMonth, setViewMonth] = useState(currentMonthKey);

  const allMonths = useMemo(()=>{
    const s=new Set(expenses.map(e=>e.month)); s.add(currentMonthKey);
    return Array.from(s).sort().reverse();
  },[expenses]);

  const mExp = useMemo(()=>expenses.filter(e=>e.month===viewMonth),[expenses,viewMonth]);
  const total = useMemo(()=>mExp.reduce((s,e)=>s+Number(e.amount),0),[mExp]);

  const prevKey = useMemo(()=>{
    const [y,m]=viewMonth.split("-").map(Number);
    const d=new Date(y,m-2,1);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  },[viewMonth]);

  const prevTotal = useMemo(()=>expenses.filter(e=>e.month===prevKey).reduce((s,e)=>s+Number(e.amount),0),[expenses,prevKey]);
  const diff = total-prevTotal;

  const catColorIdx = useMemo(()=>{ const m={}; categories.forEach((c,i)=>{m[c]=i;}); return m; },[categories]);

  const catMap = useMemo(()=>{
    const m={};
    mExp.forEach(e=>{ m[e.category]=(m[e.category]||0)+Number(e.amount); });
    return Object.entries(m).map(([name,value])=>({
      name, value, color:CAT_COLORS[(catColorIdx[name]??0)%CAT_COLORS.length]
    })).sort((a,b)=>b.value-a.value);
  },[mExp,catColorIdx]);

  const trendData = useMemo(()=>{
    const [y,m]=viewMonth.split("-").map(Number);
    return Array.from({length:6},(_,i)=>{
      const d=new Date(y,m-1-5+i,1);
      const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      return { month:MONTHS[d.getMonth()], total:expenses.filter(e=>e.month===key).reduce((s,e)=>s+Number(e.amount),0) };
    });
  },[expenses,viewMonth]);

  const topCats = catMap.slice(0,4).map(c=>c.name);
  const barData = useMemo(()=>{
    const [y,m]=viewMonth.split("-").map(Number);
    return [0,-1,-2].reverse().map(i=>{
      const d=new Date(y,m-1+i,1);
      const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      const row={ month:MONTHS[d.getMonth()] };
      const me=expenses.filter(e=>e.month===key);
      topCats.forEach(cat=>{ row[cat]=me.filter(e=>e.category===cat).reduce((s,e)=>s+Number(e.amount),0); });
      return row;
    });
  },[expenses,viewMonth,topCats]);

  const annualSummary = useMemo(()=>{
    const [y] = viewMonth.split("-").map(Number);
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth()+1;
    let lastClosedMonth;
    if (y < currentYear) lastClosedMonth = 12;
    else if (y === currentYear) lastClosedMonth = currentMonth - 1;
    else lastClosedMonth = 0;
    if (lastClosedMonth <= 0) return null;
    const yearExp = expenses.filter(e=>{
      const [ey,em]=e.month.split("-").map(Number);
      return ey===y && em<=lastClosedMonth;
    });
    if (yearExp.length===0) return null;
    const catTotals={};
    yearExp.forEach(e=>{ catTotals[e.category]=(catTotals[e.category]||0)+Number(e.amount); });
    const rows = Object.entries(catTotals)
      .map(([cat,total])=>({ cat, total, avg:total/lastClosedMonth }))
      .sort((a,b)=>b.avg-a.avg);
    return { rows, closedMonths:lastClosedMonth, year:y };
  },[expenses,viewMonth]);

  return (
    <div style={{ display:"flex", flexDirection:"column", gap:12 }}>
      <select value={viewMonth} onChange={e=>setViewMonth(e.target.value)}
        style={{ ...inputStyle, width:"auto", alignSelf:"flex-start", paddingRight:32,
          color:C.gold, background:"transparent", border:`1px solid ${C.goldDim}55`, borderRadius:8, fontSize:13 }}>
        {allMonths.map(k=><option key={k} value={k} style={{background:C.card}}>{monthLabel(k)}</option>)}
      </select>

      <Card>
        <div style={{ fontSize:10, color:C.muted, textTransform:"uppercase", letterSpacing:"0.1em" }}>Total Spent — {monthLabel(viewMonth)}</div>
        <div style={{ ...TT.display, fontSize:38, color:C.text, margin:"4px 0 2px" }}>{eur(total)}</div>
        <div style={{ fontSize:12, color:diff>0?C.red:diff<0?C.green:C.muted }}>
          {diff===0||prevTotal===0
            ? `${mExp.length} transaction${mExp.length!==1?"s":""}`
            : `${diff>0?"▲":"▼"} ${eur(Math.abs(diff))} vs ${monthLabel(prevKey)}`}
        </div>
      </Card>

      {catMap.length>0 && (
        <Card>
          <div style={{ ...TT.display, fontSize:15, color:C.gold, marginBottom:10 }}>By Category</div>
          <ResponsiveContainer width="100%" height={175}>
            <PieChart>
              <Pie data={catMap} cx="50%" cy="50%" innerRadius={50} outerRadius={80} dataKey="value" paddingAngle={2}>
                {catMap.map((c,i)=><Cell key={i} fill={c.color}/>)}
              </Pie>
              <Tooltip content={<ChartTip/>}/>
            </PieChart>
          </ResponsiveContainer>
          <div style={{ display:"flex", flexWrap:"wrap", gap:"5px 12px", marginTop:6 }}>
            {catMap.slice(0,6).map(c=>(
              <div key={c.name} style={{ display:"flex", alignItems:"center", gap:5, fontSize:11 }}>
                <span style={{ width:7, height:7, borderRadius:"50%", background:c.color, display:"inline-block" }}/>
                <span style={{ color:C.muted }}>{c.name}</span>
                <span style={{ color:C.text }}>{eur(c.value)}</span>
              </div>
            ))}
          </div>
        </Card>
      )}

      <Card>
        <div style={{ ...TT.display, fontSize:15, color:C.gold, marginBottom:10 }}>6-Month Trend</div>
        <ResponsiveContainer width="100%" height={155}>
          <LineChart data={trendData} margin={{top:5,right:5,bottom:5,left:0}}>
            <CartesianGrid strokeDasharray="3 3" stroke={C.border}/>
            <XAxis dataKey="month" tick={{fill:C.muted,fontSize:10}} axisLine={false} tickLine={false}/>
            <YAxis tick={{fill:C.muted,fontSize:10}} axisLine={false} tickLine={false} tickFormatter={v=>`€${v}`} width={38}/>
            <Tooltip content={<ChartTip/>}/>
            <Line type="monotone" dataKey="total" stroke={C.gold} strokeWidth={2} dot={{fill:C.gold,r:3}}/>
          </LineChart>
        </ResponsiveContainer>
      </Card>

      {topCats.length>0 && (
        <Card>
          <div style={{ ...TT.display, fontSize:15, color:C.gold, marginBottom:10 }}>3-Month Comparison</div>
          <ResponsiveContainer width="100%" height={170}>
            <BarChart data={barData} margin={{top:5,right:5,bottom:5,left:0}}>
              <CartesianGrid strokeDasharray="3 3" stroke={C.border}/>
              <XAxis dataKey="month" tick={{fill:C.muted,fontSize:10}} axisLine={false} tickLine={false}/>
              <YAxis tick={{fill:C.muted,fontSize:10}} axisLine={false} tickLine={false} tickFormatter={v=>`€${v}`} width={38}/>
              <Tooltip content={<ChartTip/>}/>
              <Legend wrapperStyle={{fontSize:10,color:C.muted}}/>
              {topCats.map((cat,i)=><Bar key={cat} dataKey={cat} fill={CAT_COLORS[i%CAT_COLORS.length]} radius={[3,3,0,0]}/>)}
            </BarChart>
          </ResponsiveContainer>
        </Card>
      )}

      {/* Annual Summary */}
      {annualSummary ? (
        <Card style={{ marginBottom:8 }}>
          <div style={{ ...TT.display, fontSize:15, color:C.gold, marginBottom:2 }}>{annualSummary.year} Annual Summary</div>
          <div style={{ fontSize:11, color:C.muted, marginBottom:14 }}>
            Jan – {MONTHS[annualSummary.closedMonths-1]} · {annualSummary.closedMonths} closed month{annualSummary.closedMonths!==1?"s":""} · ranked by monthly avg
          </div>
          <div style={{ display:"grid", gridTemplateColumns:"1fr auto auto", gap:"6px 12px", marginBottom:8, paddingBottom:8, borderBottom:`1px solid ${C.border}` }}>
            <div style={{ fontSize:10, color:C.faint, textTransform:"uppercase", letterSpacing:"0.08em" }}>Category</div>
            <div style={{ fontSize:10, color:C.faint, textTransform:"uppercase", letterSpacing:"0.08em", textAlign:"right" }}>Total</div>
            <div style={{ fontSize:10, color:C.faint, textTransform:"uppercase", letterSpacing:"0.08em", textAlign:"right" }}>/ Month</div>
          </div>
          <div style={{ display:"flex", flexDirection:"column", gap:0 }}>
            {annualSummary.rows.map((row,i)=>{
              const color=CAT_COLORS[(catColorIdx[row.cat]??i)%CAT_COLORS.length];
              const barPct=annualSummary.rows[0].avg>0?(row.avg/annualSummary.rows[0].avg)*100:0;
              return (
                <div key={row.cat} style={{ paddingTop:9, paddingBottom:9, borderBottom:i<annualSummary.rows.length-1?`1px solid ${C.border}33`:"none" }}>
                  <div style={{ display:"grid", gridTemplateColumns:"1fr auto auto", gap:"4px 12px", alignItems:"center" }}>
                    <div style={{ display:"flex", alignItems:"center", gap:7, minWidth:0 }}>
                      <span style={{ width:7, height:7, borderRadius:"50%", background:color, flexShrink:0 }}/>
                      <span style={{ fontSize:13, color:C.text, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap" }}>{row.cat}</span>
                    </div>
                    <div style={{ fontSize:13, color:C.muted, textAlign:"right", whiteSpace:"nowrap" }}>{eur(row.total)}</div>
                    <div style={{ ...TT.display, fontSize:14, color:C.gold, textAlign:"right", whiteSpace:"nowrap" }}>{eur(row.avg)}</div>
                  </div>
                  <div style={{ marginTop:5, height:3, background:C.faint, borderRadius:4, overflow:"hidden" }}>
                    <div style={{ height:"100%", width:`${barPct}%`, background:color, borderRadius:4 }}/>
                  </div>
                </div>
              );
            })}
          </div>
          <div style={{ marginTop:14, paddingTop:10, borderTop:`1px solid ${C.border}`, display:"grid", gridTemplateColumns:"1fr auto auto", gap:"4px 12px" }}>
            <div style={{ fontSize:12, color:C.muted, fontWeight:700 }}>Total</div>
            <div style={{ fontSize:13, color:C.text, textAlign:"right", fontWeight:700 }}>{eur(annualSummary.rows.reduce((s,r)=>s+r.total,0))}</div>
            <div style={{ ...TT.display, fontSize:14, color:C.gold, textAlign:"right" }}>{eur(annualSummary.rows.reduce((s,r)=>s+r.total,0)/annualSummary.closedMonths)}</div>
          </div>
        </Card>
      ) : (
        <Card style={{ marginBottom:8 }}>
          <div style={{ ...TT.display, fontSize:15, color:C.gold, marginBottom:4 }}>{viewMonth.split("-")[0]} Annual Summary</div>
          <div style={{ fontSize:12, color:C.muted, lineHeight:1.6 }}>
            No closed months yet. Data will appear once the first full month has passed.
          </div>
        </Card>
      )}
    </div>
  );
}

// ── Add / Edit Expense ────────────────────────────────────────────────────────
function AddExpense({ expenses, setExpenses, categories, onDone, prefill, onClose }) {
  const [form, setForm] = useState({
    description:prefill?.description||"", amount:prefill?.amount||"",
    category:prefill?.category||categories[0]||"",
    date:prefill?.date||today.toISOString().slice(0,10),
    notes:prefill?.notes||"", tags:prefill?.tags?.join(", ")||"",
  });
  const set=(k,v)=>setForm(f=>({...f,[k]:v}));

  const submit = () => {
    if (!form.description.trim()||!form.amount||isNaN(Number(form.amount))) return;
    const exp={
      id:prefill?.id||genId(), description:form.description.trim(),
      amount:parseFloat(form.amount), category:form.category, date:form.date,
      notes:form.notes.trim(), tags:form.tags.split(",").map(t=>t.trim()).filter(Boolean),
      month:form.date.slice(0,7)
    };
    if (prefill) setExpenses(e=>e.map(x=>x.id===exp.id?exp:x));
    else setExpenses(e=>[exp,...e]);
    if (onClose) onClose(); else onDone();
  };

  return (
    <div style={{ display:"flex", flexDirection:"column", gap:14, paddingBottom:8 }}>
      {!onClose && <div style={{ ...TT.display, fontSize:22, color:C.text, marginBottom:2 }}>New Expense</div>}
      <div>
        <label style={labelStyle}>Description</label>
        <input style={inputStyle} placeholder="e.g. Weekly groceries" value={form.description} onChange={e=>set("description",e.target.value)}/>
      </div>
      <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:10 }}>
        <div>
          <label style={labelStyle}>Amount (€)</label>
          <input style={inputStyle} type="number" inputMode="decimal" placeholder="0.00" value={form.amount} onChange={e=>set("amount",e.target.value)}/>
        </div>
        <div>
          <label style={labelStyle}>Date</label>
          <input style={inputStyle} type="date" value={form.date} onChange={e=>set("date",e.target.value)}/>
        </div>
      </div>
      <div>
        <label style={labelStyle}>Category</label>
        <select style={inputStyle} value={form.category} onChange={e=>set("category",e.target.value)}>
          {categories.map(c=><option key={c} style={{background:C.card}}>{c}</option>)}
        </select>
      </div>
      <div>
        <label style={labelStyle}>Notes (optional)</label>
        <input style={inputStyle} placeholder="Any extra details…" value={form.notes} onChange={e=>set("notes",e.target.value)}/>
      </div>
      <div>
        <label style={labelStyle}>Tags (comma-separated)</label>
        <input style={inputStyle} placeholder="e.g. joint, work" value={form.tags} onChange={e=>set("tags",e.target.value)}/>
      </div>
      <div style={{ display:"flex", gap:8, justifyContent:"flex-end", paddingTop:4 }}>
        {onClose && <Btn variant="ghost" onClick={onClose}>Cancel</Btn>}
        <Btn onClick={submit}>{prefill?"Save Changes":"Add Expense"}</Btn>
      </div>
    </div>
  );
}

// ── Expense List ──────────────────────────────────────────────────────────────
function ExpenseList({ expenses, setExpenses, categories }) {
  const [filterMonth, setFilterMonth] = useState(currentMonthKey);
  const [filterCat, setFilterCat] = useState("All");
  const [search, setSearch] = useState("");
  const [editing, setEditing] = useState(null);

  const allMonths = useMemo(()=>{
    const s=new Set(expenses.map(e=>e.month)); s.add(currentMonthKey);
    return Array.from(s).sort().reverse();
  },[expenses]);

  const catColorIdx = useMemo(()=>{ const m={}; categories.forEach((c,i)=>{m[c]=i;}); return m; },[categories]);

  const filtered = useMemo(()=>
    expenses.filter(e=>
      (!filterMonth||e.month===filterMonth)&&
      (filterCat==="All"||e.category===filterCat)&&
      (!search||e.description.toLowerCase().includes(search.toLowerCase())||
        e.notes?.toLowerCase().includes(search.toLowerCase())||
        e.tags?.some(t=>t.toLowerCase().includes(search.toLowerCase())))
    ).sort((a,b)=>b.date.localeCompare(a.date)),
  [expenses,filterMonth,filterCat,search]);

  const filteredTotal = useMemo(()=>filtered.reduce((s,e)=>s+Number(e.amount),0),[filtered]);
  const editingExp = editing ? expenses.find(e=>e.id===editing) : null;

  if (editing && editingExp) return (
    <div>
      <div style={{ ...TT.display, fontSize:22, color:C.text, marginBottom:14 }}>Edit Expense</div>
      <AddExpense expenses={expenses} setExpenses={setExpenses} categories={categories} prefill={editingExp} onClose={()=>setEditing(null)}/>
    </div>
  );

  return (
    <div style={{ display:"flex", flexDirection:"column", gap:10 }}>
      <div style={{ ...TT.display, fontSize:22, color:C.text }}>Expenses</div>
      <input style={inputStyle} placeholder="Search…" value={search} onChange={e=>setSearch(e.target.value)}/>
      <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:8 }}>
        <select style={{...inputStyle,fontSize:12}} value={filterMonth} onChange={e=>setFilterMonth(e.target.value)}>
          <option value="">All Months</option>
          {allMonths.map(k=><option key={k} value={k} style={{background:C.card}}>{monthLabel(k)}</option>)}
        </select>
        <select style={{...inputStyle,fontSize:12}} value={filterCat} onChange={e=>setFilterCat(e.target.value)}>
          <option>All</option>
          {categories.map(c=><option key={c} style={{background:C.card}}>{c}</option>)}
        </select>
      </div>
      {filtered.length>0 && <div style={{ fontSize:11, color:C.muted, textAlign:"right" }}>{filtered.length} entries · {eur(filteredTotal)}</div>}
      {filtered.length===0
        ? <Card style={{ textAlign:"center", color:C.muted, padding:"2.5rem 1rem" }}>No expenses found</Card>
        : filtered.map(e=>{
          const color=CAT_COLORS[(catColorIdx[e.category]??0)%CAT_COLORS.length];
          return (
            <Card key={e.id} style={{ padding:"0.9rem 1rem" }}>
              <div style={{ display:"flex", gap:10, alignItems:"flex-start" }}>
                <div style={{ width:3, alignSelf:"stretch", background:color, borderRadius:4, flexShrink:0, marginTop:2 }}/>
                <div style={{ flex:1, minWidth:0 }}>
                  <div style={{ display:"flex", justifyContent:"space-between", alignItems:"baseline" }}>
                    <span style={{ fontWeight:700, fontSize:14, color:C.text }}>{e.description}</span>
                    <span style={{ ...TT.display, fontSize:17, color:C.gold, marginLeft:8, flexShrink:0 }}>{eur(e.amount)}</span>
                  </div>
                  <div style={{ display:"flex", flexWrap:"wrap", gap:4, marginTop:5 }}>
                    <Tag label={e.category} color={color}/>
                    {e.tags?.map(t=><Tag key={t} label={t} color={C.muted}/>)}
                  </div>
                  {e.notes && <div style={{ fontSize:11, color:C.muted, marginTop:4 }}>{e.notes}</div>}
                  <div style={{ fontSize:10, color:C.faint, marginTop:4 }}>{e.date}</div>
                  <div style={{ display:"flex", gap:6, marginTop:8 }}>
                    <Btn variant="ghost" style={{ padding:"5px 12px", fontSize:11 }} onClick={()=>setEditing(e.id)}>Edit</Btn>
                    <Btn variant="danger" style={{ padding:"5px 12px", fontSize:11 }} onClick={()=>setExpenses(ex=>ex.filter(x=>x.id!==e.id))}>Delete</Btn>
                  </div>
                </div>
              </div>
            </Card>
          );
        })
      }
    </div>
  );
}

// ── Recurring ─────────────────────────────────────────────────────────────────
function RecurringPage({ recurring, setRecurring, categories, expenses, setExpenses, showToast }) {
  const [showAdd, setShowAdd] = useState(false);
  const [form, setForm] = useState({ description:"", amount:"", category:categories[0]||"", notes:"", tags:"", dayOfMonth:"1" });
  const set=(k,v)=>setForm(f=>({...f,[k]:v}));

  const addR = () => {
    if (!form.description.trim()||!form.amount||isNaN(Number(form.amount))) return;
    setRecurring(r=>[...r,{
      id:genId(), ...form, amount:parseFloat(form.amount),
      tags:form.tags.split(",").map(t=>t.trim()).filter(Boolean),
      dayOfMonth:parseInt(form.dayOfMonth)||1
    }]);
    setForm({ description:"", amount:"", category:categories[0]||"", notes:"", tags:"", dayOfMonth:"1" });
    setShowAdd(false);
  };

  const postNow = (rec) => {
    const d=new Date(today.getFullYear(),today.getMonth(),Math.min(rec.dayOfMonth||1,28));
    const dateStr=d.toISOString().slice(0,10);
    const month=dateStr.slice(0,7);
    if (expenses.some(e=>e.recurringId===rec.id&&e.month===month)) {
      showToast("Already posted this month","err"); return;
    }
    setExpenses(e=>[{ id:genId(), description:rec.description, amount:rec.amount,
      category:rec.category, date:dateStr, notes:rec.notes, tags:rec.tags, month, recurringId:rec.id },...e]);
    showToast(`${rec.description} posted ✓`);
  };

  return (
    <div style={{ display:"flex", flexDirection:"column", gap:12 }}>
      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
        <div style={{ ...TT.display, fontSize:22, color:C.text }}>Recurring</div>
        <Btn onClick={()=>setShowAdd(v=>!v)} variant={showAdd?"ghost":"primary"} style={{ padding:"8px 14px", fontSize:12 }}>
          {showAdd?"Cancel":"+ Add"}
        </Btn>
      </div>
      {showAdd && (
        <Card>
          <div style={{ display:"flex", flexDirection:"column", gap:12 }}>
            <div><label style={labelStyle}>Description</label><input style={inputStyle} placeholder="e.g. Rent" value={form.description} onChange={e=>set("description",e.target.value)}/></div>
            <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:10 }}>
              <div><label style={labelStyle}>Amount (€)</label><input style={inputStyle} type="number" inputMode="decimal" placeholder="0.00" value={form.amount} onChange={e=>set("amount",e.target.value)}/></div>
              <div><label style={labelStyle}>Day of Month</label><input style={inputStyle} type="number" min="1" max="28" value={form.dayOfMonth} onChange={e=>set("dayOfMonth",e.target.value)}/></div>
            </div>
            <div><label style={labelStyle}>Category</label>
              <select style={inputStyle} value={form.category} onChange={e=>set("category",e.target.value)}>
                {categories.map(c=><option key={c} style={{background:C.card}}>{c}</option>)}
              </select>
            </div>
            <div><label style={labelStyle}>Notes</label><input style={inputStyle} value={form.notes} onChange={e=>set("notes",e.target.value)}/></div>
            <div><label style={labelStyle}>Tags</label><input style={inputStyle} placeholder="rent, fixed" value={form.tags} onChange={e=>set("tags",e.target.value)}/></div>
            <div style={{ display:"flex", justifyContent:"flex-end" }}><Btn onClick={addR}>Save</Btn></div>
          </div>
        </Card>
      )}
      {recurring.length===0&&!showAdd
        ? <Card style={{ textAlign:"center", color:C.muted, padding:"2.5rem 1rem" }}>No recurring expenses yet</Card>
        : recurring.map((r,i)=>{
          const color=CAT_COLORS[i%CAT_COLORS.length];
          const posted=expenses.some(e=>e.recurringId===r.id&&e.month===currentMonthKey);
          return (
            <Card key={r.id} style={{ padding:"0.9rem 1rem" }}>
              <div style={{ display:"flex", gap:10, alignItems:"flex-start" }}>
                <div style={{ width:3, alignSelf:"stretch", background:color, borderRadius:4, flexShrink:0, marginTop:2 }}/>
                <div style={{ flex:1 }}>
                  <div style={{ display:"flex", justifyContent:"space-between", alignItems:"baseline" }}>
                    <span style={{ fontWeight:700, fontSize:14, color:C.text }}>{r.description}</span>
                    <span style={{ ...TT.display, fontSize:17, color:C.gold }}>{eur(r.amount)}</span>
                  </div>
                  <div style={{ display:"flex", gap:4, marginTop:5, flexWrap:"wrap" }}>
                    <Tag label={r.category} color={color}/>
                    <Tag label={`Day ${r.dayOfMonth}`} color={C.muted}/>
                  </div>
                  <div style={{ display:"flex", gap:6, marginTop:10 }}>
                    <Btn variant={posted?"success":"ghost"} style={{ padding:"5px 12px", fontSize:11 }}
                      disabled={posted} onClick={()=>!posted&&postNow(r)}>
                      {posted?"✓ Posted":"Post Now"}
                    </Btn>
                    <Btn variant="danger" style={{ padding:"5px 12px", fontSize:11 }}
                      onClick={()=>setRecurring(rx=>rx.filter(x=>x.id!==r.id))}>Delete</Btn>
                  </div>
                </div>
              </div>
            </Card>
          );
        })
      }
    </div>
  );
}

// ── Settings ──────────────────────────────────────────────────────────────────
function Settings({ expenses, recurring, categories, setExpenses, setRecurring, setCategories, showToast }) {
  const fileInputRef = useRef(null);
  const [newCat, setNewCat] = useState("");
  const [confirmClear, setConfirmClear] = useState(false);

  const exportData = () => {
    const backup = { version:1, exportedAt:new Date().toISOString(), expenses, recurring, categories };
    const blob = new Blob([JSON.stringify(backup,null,2)],{type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download=`yg-budget-${today.toISOString().slice(0,10)}.json`; a.click();
    URL.revokeObjectURL(url);
    showToast("Backup downloaded ✓");
  };

  const importData = (e) => {
    const file=e.target.files?.[0]; if (!file) return;
    const reader=new FileReader();
    reader.onload=(ev)=>{
      try {
        const data=JSON.parse(ev.target.result);
        if (!data.expenses||!Array.isArray(data.expenses)) throw new Error("bad format");
        setExpenses(data.expenses);
        if (data.recurring) setRecurring(data.recurring);
        if (data.categories) setCategories(data.categories);
        showToast(`Imported ${data.expenses.length} expense${data.expenses.length!==1?"s":""} ✓`);
      } catch { showToast("Import failed — invalid file","err"); }
    };
    reader.readAsText(file);
    e.target.value="";
  };

  const addCat = () => {
    const t=newCat.trim(); if (!t||categories.includes(t)) return;
    setCategories(c=>[...c,t]); setNewCat("");
  };

  const clearAll = () => {
    setExpenses([]); setRecurring([]); setCategories(DEFAULT_CATEGORIES);
    lsSave("yg_expenses",[]); lsSave("yg_recurring",[]); lsSave("yg_categories",DEFAULT_CATEGORIES);
    setConfirmClear(false); showToast("All data cleared");
  };

  return (
    <div style={{ display:"flex", flexDirection:"column", gap:14, paddingBottom:8 }}>
      <div style={{ ...TT.display, fontSize:22, color:C.text }}>Settings</div>

      <Card>
        <div style={{ ...TT.display, fontSize:16, color:C.gold, marginBottom:6 }}>Backup &amp; Restore</div>
        <div style={{ fontSize:12, color:C.muted, marginBottom:14, lineHeight:1.65 }}>
          Download all your data as a JSON file. Re-import it anytime to fully restore your tracker.
        </div>
        <div style={{ background:"#1A1713", borderRadius:10, padding:"10px 14px", marginBottom:14,
          display:"grid", gridTemplateColumns:"1fr 1fr 1fr", gap:6, textAlign:"center" }}>
          {[["Expenses",expenses.length],["Recurring",recurring.length],["Categories",categories.length]].map(([label,val])=>(
            <div key={label}>
              <div style={{ ...TT.display, fontSize:20, color:C.text }}>{val}</div>
              <div style={{ fontSize:10, color:C.muted, textTransform:"uppercase", letterSpacing:"0.08em" }}>{label}</div>
            </div>
          ))}
        </div>
        <div style={{ display:"flex", flexDirection:"column", gap:9 }}>
          <Btn onClick={exportData} style={{ width:"100%", textAlign:"center" }}>↓ &nbsp;Export Backup</Btn>
          <input ref={fileInputRef} type="file" accept=".json" style={{ display:"none" }} onChange={importData}/>
          <Btn variant="ghost" onClick={()=>fileInputRef.current?.click()} style={{ width:"100%", textAlign:"center" }}>↑ &nbsp;Import from Backup</Btn>
        </div>
        <div style={{ fontSize:10, color:C.faint, marginTop:12, lineHeight:1.6, textAlign:"center" }}>
          Tip: export a backup after each session as a safety net.
        </div>
      </Card>

      <Card>
        <div style={{ ...TT.display, fontSize:16, color:C.gold, marginBottom:12 }}>Categories</div>
        <div style={{ display:"flex", gap:8, marginBottom:10 }}>
          <input style={{...inputStyle,flex:1}} placeholder="New category…" value={newCat}
            onChange={e=>setNewCat(e.target.value)} onKeyDown={e=>e.key==="Enter"&&addCat()}/>
          <Btn onClick={addCat} style={{ padding:"11px 14px", flexShrink:0 }}>Add</Btn>
        </div>
        <div style={{ display:"flex", flexDirection:"column", gap:6 }}>
          {categories.map((cat,i)=>(
            <div key={cat} style={{ display:"flex", alignItems:"center", gap:8, background:"#1A1713", borderRadius:8, padding:"8px 10px" }}>
              <span style={{ width:8, height:8, borderRadius:"50%", background:CAT_COLORS[i%CAT_COLORS.length], flexShrink:0 }}/>
              <span style={{ flex:1, fontSize:13, color:C.text }}>{cat}</span>
              <button onClick={()=>setCategories(c=>c.filter(x=>x!==cat))}
                style={{ background:"none", border:"none", color:C.muted, cursor:"pointer", fontSize:18, lineHeight:1, padding:"0 2px" }}>×</button>
            </div>
          ))}
        </div>
      </Card>

      <Card style={{ borderColor:`${C.red}33`, marginBottom:8 }}>
        <div style={{ ...TT.display, fontSize:16, color:C.red, marginBottom:6 }}>Danger Zone</div>
        <div style={{ fontSize:12, color:C.muted, marginBottom:14, lineHeight:1.65 }}>
          Wipe all expenses, recurring entries and reset categories. Export a backup first!
        </div>
        {!confirmClear
          ? <Btn variant="danger" onClick={()=>setConfirmClear(true)} style={{ width:"100%", textAlign:"center" }}>Clear All Data</Btn>
          : (
            <div style={{ display:"flex", flexDirection:"column", gap:8 }}>
              <div style={{ fontSize:12, color:C.red, textAlign:"center" }}>Are you sure? This cannot be undone.</div>
              <div style={{ display:"flex", gap:8 }}>
                <Btn variant="ghost" onClick={()=>setConfirmClear(false)} style={{ flex:1, textAlign:"center" }}>Cancel</Btn>
                <Btn variant="danger" onClick={clearAll} style={{ flex:1, textAlign:"center" }}>Yes, Clear All</Btn>
              </div>
            </div>
          )
        }
      </Card>
    </div>
  );
}

// ── Mount ─────────────────────────────────────────────────────────────────────
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App/>);
</script>
</body>
</html>
